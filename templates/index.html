<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speedify Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            animation: slideDown 0.8s ease-out;
        }

        .header h1 {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 700;
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 1.1rem;
            color: #888;
            font-weight: 400;
        }

        .mode-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .mode-button {
            padding: 12px 24px;
            border: 2px solid rgba(0, 212, 255, 0.3);
            background: linear-gradient(145deg, #1e1e1e 0%, #2a2a2a 100%);
            color: #00d4ff;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            min-width: 120px;
            text-align: center;
        }

        .mode-button:hover:not(.active):not(.disabled) {
            background: linear-gradient(145deg, #2a2a2a 0%, #3a3a3a 100%);
            border-color: rgba(0, 212, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .mode-button.active {
            background: linear-gradient(145deg, #0a3a3a 0%, #0a4a4a 100%);
            border-color: #00d4ff;
            color: #fff;
            cursor: not-allowed;
        }

        .mode-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .mode-button.loading {
            pointer-events: none;
        }

        .mode-button.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.good { background: #00ff88; }
        .status-dot.warn { background: #ffaa00; }
        .status-dot.bad { background: #ff4444; }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            gap: 25px;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto;
        }

        .server-info {
            grid-column: 1 / -1;
        }

        .section {
            animation: slideUp 0.8s ease-out;
            animation-fill-mode: both;
        }

        .section:nth-child(1) { animation-delay: 0.1s; }
        .section:nth-child(2) { animation-delay: 0.2s; }
        .section:nth-child(3) { animation-delay: 0.3s; }
        .section:nth-child(4) { animation-delay: 0.4s; }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            border-radius: 2px;
        }

        .card {
            background: linear-gradient(145deg, #1e1e1e 0%, #2a2a2a 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            height: fit-content;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.5), transparent);
            transform: translateX(-100%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .card:hover {
            transform: translateY(-4px);
            border-color: rgba(0, 212, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 20px rgba(0, 212, 255, 0.1);
        }

        .card.good { 
            border-left: 4px solid #00ff88;
            background: linear-gradient(145deg, #1e2e1e 0%, #2a3a2a 100%);
        }
        .card.warn { 
            border-left: 4px solid #ffaa00;
            background: linear-gradient(145deg, #2e2e1e 0%, #3a3a2a 100%);
        }
        .card.bad { 
            border-left: 4px solid #ff4444;
            background: linear-gradient(145deg, #2e1e1e 0%, #3a2a2a 100%);
        }

        .session-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .session-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .session-label {
            font-size: 0.85rem;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .session-value {
            font-size: 1.4rem;
            font-weight: 600;
            color: #fff;
        }

        .adapter-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            transition: all 0.3s ease;
        }

        .adapter-card:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(5px);
        }

        .adapter-card.good { 
            border-color: rgba(0, 255, 136, 0.3);
            background: rgba(0, 255, 136, 0.05);
        }
        .adapter-card.warn { 
            border-color: rgba(255, 170, 0, 0.3);
            background: rgba(255, 170, 0, 0.05);
        }
        .adapter-card.bad { 
            border-color: rgba(255, 68, 68, 0.3);
            background: rgba(255, 68, 68, 0.05);
        }

        .adapter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .adapter-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
        }

        .adapter-type {
            font-size: 0.8rem;
            color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .adapter-status {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .adapter-status.good { background: #00ff88; }
        .adapter-status.warn { background: #ffaa00; }
        .adapter-status.bad { background: #ff4444; }

        .adapter-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .adapter-detail {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.9rem;
        }

        .detail-label {
            color: #ccc;
            font-weight: 500;
        }

        .detail-value {
            color: #fff;
            font-weight: 600;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 212, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #00d4ff;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideDown {
            0% { opacity: 0; transform: translateY(-30px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            0% { opacity: 0; transform: translateY(30px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .warning-indicators {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .warning-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            background: rgba(255, 68, 68, 0.1);
            color: #ff4444;
            border: 1px solid rgba(255, 68, 68, 0.2);
        }

        /* Status Bar: Connection state + Server info */
        .status-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            margin: 15px auto 0;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            max-width: 900px;
        }

        .status-bar-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .status-bar-item .status-dot {
            width: 10px;
            height: 10px;
        }

        .status-bar-label {
            color: #666;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-bar-value {
            color: #fff;
            font-weight: 500;
        }

        .status-bar-value.good { color: #00ff88; }
        .status-bar-value.warn { color: #ffaa00; }
        .status-bar-value.bad { color: #ff4444; }

        .status-bar-divider {
            width: 1px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
        }

        .mode-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(0, 212, 255, 0.15);
            color: #00d4ff;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        @media (max-width: 768px) {
            .status-bar {
                padding: 10px 15px;
                gap: 6px;
            }
            .status-bar-item {
                padding: 5px 10px;
                font-size: 0.8rem;
            }
            .status-bar-divider {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .status-bar {
                flex-direction: column;
                gap: 8px;
            }
            .status-bar-item {
                width: 100%;
                justify-content: center;
            }
        }

        /* Combined Health + Metrics Widget */
        .status-hero {
            display: flex;
            align-items: stretch;
            gap: 20px;
            margin: 20px auto 30px;
            padding: 20px;
            background: linear-gradient(145deg, #1a1a1a 0%, #252525 100%);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 900px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .health-score-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 25px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .health-score-container {
            position: relative;
            width: 100px;
            height: 100px;
        }

        .health-score-ring {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                var(--health-color, #00ff88) calc(var(--health-percent, 0) * 3.6deg),
                rgba(255, 255, 255, 0.1) 0deg
            );
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            animation: pulse-ring 2s ease-in-out infinite;
        }

        @keyframes pulse-ring {
            0%, 100% { box-shadow: 0 0 15px rgba(var(--health-rgb, 0, 255, 136), 0.3); }
            50% { box-shadow: 0 0 30px rgba(var(--health-rgb, 0, 255, 136), 0.5); }
        }

        .health-score-inner {
            width: 76px;
            height: 76px;
            border-radius: 50%;
            background: linear-gradient(145deg, #1e1e1e 0%, #2a2a2a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .health-score-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--health-color, #00ff88);
            line-height: 1;
        }

        .health-score-label {
            font-size: 0.6rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 2px;
        }

        .health-status-text {
            margin-top: 8px;
            text-align: center;
        }

        .health-status {
            font-size: 1rem;
            font-weight: 700;
            color: var(--health-color, #00ff88);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .health-trend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
        }

        .health-trend-arrow {
            font-size: 0.9rem;
        }

        .health-trend-arrow.up { color: #00ff88; }
        .health-trend-arrow.down { color: #ff4444; }
        .health-trend-arrow.stable { color: #888; }

        /* Glanceable Metrics Grid */
        .metrics-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            flex: 1;
        }

        .metric-tile {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            transition: all 0.2s ease;
            min-height: 80px;
        }

        .metric-tile:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .metric-tile.good { border-color: rgba(0, 255, 136, 0.3); }
        .metric-tile.warn { border-color: rgba(255, 170, 0, 0.3); }
        .metric-tile.bad { border-color: rgba(255, 68, 68, 0.3); }

        .metric-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: #fff;
            line-height: 1;
            display: flex;
            align-items: baseline;
            gap: 2px;
        }

        .metric-value.good { color: #00ff88; }
        .metric-value.warn { color: #ffaa00; }
        .metric-value.bad { color: #ff4444; }

        .metric-unit {
            font-size: 0.8rem;
            font-weight: 400;
            color: #666;
        }

        .metric-label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 6px;
            text-align: center;
        }

        .warning-indicators {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
            justify-content: center;
        }

        .warning-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            background: rgba(255, 68, 68, 0.1);
            color: #ff4444;
            border: 1px solid rgba(255, 68, 68, 0.2);
        }

        /* Mobile responsiveness for status hero */
        @media (max-width: 768px) {
            .status-hero {
                flex-direction: column;
                padding: 15px;
                gap: 15px;
            }

            .health-score-section {
                border-right: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                padding: 10px 15px 20px;
                flex-direction: row;
                gap: 20px;
            }

            .health-score-container {
                width: 80px;
                height: 80px;
            }

            .health-score-inner {
                width: 60px;
                height: 60px;
            }

            .health-score-value {
                font-size: 1.5rem;
            }

            .health-status-text {
                margin-top: 0;
                text-align: left;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .metric-tile {
                min-height: 70px;
                padding: 10px 6px;
            }

            .metric-value {
                font-size: 1.4rem;
            }
        }

        @media (max-width: 400px) {
            .health-score-section {
                flex-direction: column;
            }

            .health-status-text {
                text-align: center;
            }
        }

        /* Mobile responsiveness */
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body { padding: 15px; }
            .dashboard { gap: 20px; }
            .card { padding: 20px; }
            .session-grid { grid-template-columns: 1fr; }
        }

        /* Dark scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: linear-gradient(145deg, #2a2a2a 0%, #1e1e1e 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px 20px;
            min-width: 280px;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            pointer-events: auto;
        }

        .toast.hiding {
            animation: slideOut 0.3s ease-in forwards;
        }

        .toast-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 0.85rem;
            color: #999;
        }

        .toast-close {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 4px;
            font-size: 1.2rem;
            line-height: 1;
            transition: color 0.2s;
        }

        .toast-close:hover {
            color: #fff;
        }

        .toast.success {
            border-left: 4px solid #00ff88;
        }
        .toast.success .toast-icon { color: #00ff88; }
        .toast.success .toast-title { color: #00ff88; }

        .toast.error {
            border-left: 4px solid #ff4444;
        }
        .toast.error .toast-icon { color: #ff4444; }
        .toast.error .toast-title { color: #ff4444; }

        .toast.warning {
            border-left: 4px solid #ffaa00;
        }
        .toast.warning .toast-icon { color: #ffaa00; }
        .toast.warning .toast-title { color: #ffaa00; }

        .toast.info {
            border-left: 4px solid #00d4ff;
        }
        .toast.info .toast-icon { color: #00d4ff; }
        .toast.info .toast-title { color: #00d4ff; }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Connection error banner */
        .connection-error-banner {
            display: none;
            background: linear-gradient(145deg, #3a2020 0%, #2a1515 100%);
            border: 1px solid rgba(255, 68, 68, 0.3);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        .connection-error-banner.visible {
            display: block;
        }

        .connection-error-banner .error-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .connection-error-banner .error-text {
            color: #ff6666;
            font-weight: 500;
        }

        .connection-error-banner .error-subtext {
            color: #999;
            font-size: 0.85rem;
            margin-top: 4px;
        }

        @media (max-width: 768px) {
            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
            }
            .toast {
                min-width: auto;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <!-- Toast notification container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Connection error banner -->
    <div class="connection-error-banner" id="connection-error-banner">
        <div class="error-icon">&#9888;</div>
        <div class="error-text">Connection to dashboard server lost</div>
        <div class="error-subtext">Attempting to reconnect...</div>
    </div>

    <div class="header">
        <h1>Speedify Dashboard</h1>
        <p class="subtitle">Advanced Network Bonding Monitor</p>

        <!-- Status Bar: Connection state + Server info -->
        <div class="status-bar">
            <div class="status-bar-item">
                <div class="status-dot good" id="overall-dot"></div>
                <span class="status-bar-value" id="overall-state">Connecting...</span>
            </div>
            <div class="status-bar-divider"></div>
            <div class="status-bar-item">
                <span class="status-bar-label">Mode</span>
                <span class="mode-badge" id="bonding-mode">...</span>
            </div>
            <div class="status-bar-divider"></div>
            <div class="status-bar-item">
                <span class="status-bar-label">Server</span>
                <span class="status-bar-value" id="server-location">...</span>
            </div>
            <div class="status-bar-divider"></div>
            <div class="status-bar-item">
                <span class="status-bar-label">IP</span>
                <span class="status-bar-value" id="server-ip">...</span>
            </div>
        </div>

        <!-- Combined Status Hero: Health Score + Key Metrics -->
        <div class="status-hero" id="status-hero">
            <div class="health-score-section">
                <div class="health-score-container">
                    <div class="health-score-ring" id="health-ring">
                        <div class="health-score-inner">
                            <div class="health-score-value" id="health-score">--</div>
                            <div class="health-score-label">Health</div>
                        </div>
                    </div>
                </div>
                <div class="health-status-text">
                    <div class="health-status" id="health-status">Loading...</div>
                    <div class="health-trend" id="health-trend">
                        <span class="health-trend-arrow stable" id="health-trend-arrow">→</span>
                        <span id="health-trend-text">Measuring...</span>
                    </div>
                </div>
            </div>
            <div class="metrics-section">
                <div class="metrics-grid">
                    <div class="metric-tile" id="tile-latency">
                        <div class="metric-value" id="perf-latency">--<span class="metric-unit">ms</span></div>
                        <div class="metric-label">Latency</div>
                    </div>
                    <div class="metric-tile" id="tile-jitter">
                        <div class="metric-value" id="perf-jitter">--<span class="metric-unit">ms</span></div>
                        <div class="metric-label">Jitter</div>
                    </div>
                    <div class="metric-tile" id="tile-mos">
                        <div class="metric-value" id="perf-mos">--<span class="metric-unit">/5</span></div>
                        <div class="metric-label">MOS Score</div>
                    </div>
                    <div class="metric-tile" id="tile-loss">
                        <div class="metric-value" id="perf-loss">--<span class="metric-unit">%</span></div>
                        <div class="metric-label">Packet Loss</div>
                    </div>
                </div>
                <div class="warning-indicators" id="warning-indicators"></div>
            </div>
        </div>

        <div class="mode-controls">
            <button class="mode-button" id="mode-streaming" onclick="changeMode('streaming')">
                Streaming
            </button>
            <button class="mode-button" id="mode-speed" onclick="changeMode('speed')">
                Speed
            </button>
            <button class="mode-button" id="mode-redundant" onclick="changeMode('redundant')">
                Redundant
            </button>
        </div>
    </div>

    <div class="dashboard">
        <div class="section">
            <h2 class="section-title">Session Statistics</h2>
            <div class="card">
                <div class="session-grid">
                    <div class="session-card">
                        <div class="session-label">Uptime</div>
                        <div class="session-value" id="session-uptime"><div class="loading"></div></div>
                    </div>
                    <div class="session-card">
                        <div class="session-label">Data Received</div>
                        <div class="session-value" id="session-received"><div class="loading"></div></div>
                    </div>
                    <div class="session-card">
                        <div class="session-label">Data Sent</div>
                        <div class="session-value" id="session-sent"><div class="loading"></div></div>
                    </div>
                    <div class="session-card">
                        <div class="session-label">Failovers</div>
                        <div class="session-value" id="session-failovers"><div class="loading"></div></div>
                    </div>
                    <div class="session-card">
                        <div class="session-label">Max Download</div>
                        <div class="session-value" id="session-max-down"><div class="loading"></div></div>
                    </div>
                    <div class="session-card">
                        <div class="session-label">Max Upload</div>
                        <div class="session-value" id="session-max-up"><div class="loading"></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Network Adapters</h2>
            <div class="card">
                <div id="adapters-container">
                    <div class="loading" style="margin: 20px auto; display: block;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Track previous health score for trend calculation
        let previousHealthScore = null;

        // Track connection state for error banner
        let consecutiveErrors = 0;
        const MAX_ERRORS_BEFORE_BANNER = 2;

        // Debounce flag for mode changes
        let modeChangeInProgress = false;

        // Toast notification system
        function showToast(type, title, message, duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: '&#10004;',
                error: '&#10006;',
                warning: '&#9888;',
                info: '&#8505;'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;

            container.appendChild(toast);

            // Auto-remove after duration
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Show/hide connection error banner
        function setConnectionError(hasError) {
            const banner = document.getElementById('connection-error-banner');
            if (hasError) {
                consecutiveErrors++;
                if (consecutiveErrors >= MAX_ERRORS_BEFORE_BANNER) {
                    banner.classList.add('visible');
                }
            } else {
                if (consecutiveErrors >= MAX_ERRORS_BEFORE_BANNER) {
                    banner.classList.remove('visible');
                    showToast('success', 'Connection Restored', 'Dashboard is receiving data again');
                }
                consecutiveErrors = 0;
            }
        }

        function updateHealthWidget(score, status) {
            const healthScore = document.getElementById('health-score');
            const healthStatus = document.getElementById('health-status');
            const healthRing = document.getElementById('health-ring');
            const healthTrendArrow = document.getElementById('health-trend-arrow');
            const healthTrendText = document.getElementById('health-trend-text');

            // Determine color based on score
            let color, rgb, statusText;
            if (score >= 80) {
                color = '#00ff88';
                rgb = '0, 255, 136';
                statusText = 'Excellent';
            } else if (score >= 60) {
                color = '#88ff00';
                rgb = '136, 255, 0';
                statusText = 'Good';
            } else if (score >= 40) {
                color = '#ffaa00';
                rgb = '255, 170, 0';
                statusText = 'Fair';
            } else if (score >= 20) {
                color = '#ff6600';
                rgb = '255, 102, 0';
                statusText = 'Poor';
            } else {
                color = '#ff4444';
                rgb = '255, 68, 68';
                statusText = 'Critical';
            }

            // Update score and colors
            healthScore.textContent = score;
            healthScore.style.color = color;
            healthStatus.textContent = statusText;
            healthStatus.style.color = color;

            // Update ring gradient
            healthRing.style.setProperty('--health-color', color);
            healthRing.style.setProperty('--health-rgb', rgb);
            healthRing.style.setProperty('--health-percent', score);
            healthRing.style.background = `conic-gradient(${color} ${score * 3.6}deg, rgba(255, 255, 255, 0.1) 0deg)`;

            // Calculate trend
            if (previousHealthScore !== null) {
                const diff = score - previousHealthScore;
                if (diff > 2) {
                    healthTrendArrow.textContent = '↑';
                    healthTrendArrow.className = 'health-trend-arrow up';
                    healthTrendText.textContent = 'Improving';
                } else if (diff < -2) {
                    healthTrendArrow.textContent = '↓';
                    healthTrendArrow.className = 'health-trend-arrow down';
                    healthTrendText.textContent = 'Degrading';
                } else {
                    healthTrendArrow.textContent = '→';
                    healthTrendArrow.className = 'health-trend-arrow stable';
                    healthTrendText.textContent = 'Stable';
                }
            }
            previousHealthScore = score;
        }

        function getStatusClass(value, type) {
            if (value === 'N/A' || value === 0) return 'good';
            
            switch(type) {
                case 'latency':
                    if (value <= 50) return 'good';
                    if (value <= 100) return 'warn';
                    return 'bad';
                case 'jitter':
                    if (value <= 10) return 'good';
                    if (value <= 30) return 'warn';
                    return 'bad';
                case 'mos':
                    if (value >= 4.0) return 'good';
                    if (value >= 3.5) return 'warn';
                    return 'bad';
                case 'loss':
                    if (value === 0) return 'good';
                    if (value < 1.0) return 'warn';
                    return 'bad';
                default:
                    return 'good';
            }
        }

        function updateServerInfo() {
            fetch("/api/server")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("server-location").textContent = data.location;
                    document.getElementById("server-ip").textContent = data.publicIP;
                })
                .catch(error => {
                    console.error("Error fetching server info:", error);
                    document.getElementById("server-location").textContent = "Error";
                    document.getElementById("server-ip").textContent = "Error";
                });
        }

        function updateStatus() {
            fetch("/api/status")
                .then(response => response.json())
                .then(data => {
                    // Clear connection error state on successful fetch
                    setConnectionError(false);

                    // Update overall status in status bar
                    const overallDot = document.getElementById("overall-dot");
                    const overallState = document.getElementById("overall-state");
                    const bondingMode = document.getElementById("bonding-mode");

                    overallDot.className = `status-dot ${data.overall.status}`;
                    overallState.textContent = data.overall.state;
                    overallState.className = `status-bar-value ${data.overall.status}`;
                    bondingMode.textContent = data.overall.bondingMode.toUpperCase();

                    // Update mode buttons
                    updateModeButtons(data.overall.bondingMode);

                    // Update health widget
                    updateHealthWidget(data.overall.healthScore, data.overall.status);

                    // Update performance metrics in status hero
                    const perf = data.performance;

                    // Update latency tile
                    const latencyStatus = getStatusClass(perf.latency, 'latency');
                    document.getElementById("tile-latency").className = `metric-tile ${latencyStatus}`;
                    document.getElementById("perf-latency").innerHTML = `${perf.latency}<span class="metric-unit">ms</span>`;
                    document.getElementById("perf-latency").className = `metric-value ${latencyStatus}`;

                    // Update jitter tile
                    const jitterStatus = getStatusClass(perf.jitter, 'jitter');
                    document.getElementById("tile-jitter").className = `metric-tile ${jitterStatus}`;
                    document.getElementById("perf-jitter").innerHTML = `${perf.jitter}<span class="metric-unit">ms</span>`;
                    document.getElementById("perf-jitter").className = `metric-value ${jitterStatus}`;

                    // Update MOS tile
                    const mosStatus = getStatusClass(perf.mos, 'mos');
                    document.getElementById("tile-mos").className = `metric-tile ${mosStatus}`;
                    document.getElementById("perf-mos").innerHTML = `${perf.mos}<span class="metric-unit">/5</span>`;
                    document.getElementById("perf-mos").className = `metric-value ${mosStatus}`;

                    // Update packet loss tile
                    const maxLoss = Math.max(perf.lossSend, perf.lossReceive);
                    const lossStatus = getStatusClass(maxLoss, 'loss');
                    document.getElementById("tile-loss").className = `metric-tile ${lossStatus}`;
                    document.getElementById("perf-loss").innerHTML = `${maxLoss.toFixed(2)}<span class="metric-unit">%</span>`;
                    document.getElementById("perf-loss").className = `metric-value ${lossStatus}`;

                    // Update warning indicators
                    const warningContainer = document.getElementById("warning-indicators");
                    warningContainer.innerHTML = '';
                    
                    const warnings = [];
                    if (data.overall.badIndicators.badCpu) warnings.push('High CPU');
                    if (data.overall.badIndicators.badLatency) warnings.push('High Latency');
                    if (data.overall.badIndicators.badLoss) warnings.push('Packet Loss');
                    if (data.overall.badIndicators.badMemory) warnings.push('Memory Issues');
                    
                    warnings.forEach(warning => {
                        const badge = document.createElement('div');
                        badge.className = 'warning-badge';
                        badge.textContent = warning;
                        warningContainer.appendChild(badge);
                    });
                    
                    // Update session statistics
                    const session = data.session;
                    document.getElementById("session-uptime").textContent = session.uptime;
                    document.getElementById("session-received").textContent = session.bytesReceived;
                    document.getElementById("session-sent").textContent = session.bytesSent;
                    document.getElementById("session-failovers").textContent = session.failovers;
                    document.getElementById("session-max-down").textContent = `${session.maxDownloadSpeed} Mbps`;
                    document.getElementById("session-max-up").textContent = `${session.maxUploadSpeed} Mbps`;
                    
                    // Update adapters
                    const adaptersContainer = document.getElementById("adapters-container");
                    if (data.adapters && data.adapters.length > 0) {
                        adaptersContainer.innerHTML = "";
                        data.adapters.forEach(adapter => {
                            const adapterCard = document.createElement("div");
                            adapterCard.className = `adapter-card ${adapter.status}`;
                            
                            let connectionStatsHTML = '';
                            if (adapter.connectionStats) {
                                const conn = adapter.connectionStats;
                                connectionStatsHTML = `
                                    <div class="adapter-detail">
                                        <span class="detail-label">Latency</span>
                                        <span class="detail-value" style="color: ${getStatusColor(getStatusClass(conn.latency, 'latency'))}">${conn.latency}ms</span>
                                    </div>
                                    <div class="adapter-detail">
                                        <span class="detail-label">Jitter</span>
                                        <span class="detail-value">${conn.jitter}ms</span>
                                    </div>
                                    <div class="adapter-detail">
                                        <span class="detail-label">MOS</span>
                                        <span class="detail-value" style="color: ${getStatusColor(getStatusClass(conn.mos, 'mos'))}">${conn.mos.toFixed(2)}</span>
                                    </div>
                                    <div class="adapter-detail">
                                        <span class="detail-label">Speed</span>
                                        <span class="detail-value">${formatSpeed(conn.totalBps)}</span>
                                    </div>
                                `;
                            }
                            
                            adapterCard.innerHTML = `
                                <div class="adapter-status ${adapter.status}"></div>
                                <div class="adapter-header">
                                    <div class="adapter-name">${adapter.name}</div>
                                    <div class="adapter-type">${adapter.type}</div>
                                </div>
                                <div class="adapter-details">
                                    <div class="adapter-detail">
                                        <span class="detail-label">ISP</span>
                                        <span class="detail-value">${adapter.isp}</span>
                                    </div>
                                    <div class="adapter-detail">
                                        <span class="detail-label">State</span>
                                        <span class="detail-value">${adapter.state}</span>
                                    </div>
                                    <div class="adapter-detail">
                                        <span class="detail-label">Priority</span>
                                        <span class="detail-value">${adapter.workingPriority}</span>
                                    </div>
                                    <div class="adapter-detail">
                                        <span class="detail-label">Daily Usage</span>
                                        <span class="detail-value">${adapter.dataUsage.daily}</span>
                                    </div>
                                    ${connectionStatsHTML}
                                </div>
                            `;
                            adaptersContainer.appendChild(adapterCard);
                        });
                    } else {
                        adaptersContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No adapters available</p>';
                    }
                })
                .catch(error => {
                    console.error("Error fetching status:", error);
                    // Track connection errors and show banner if persistent
                    setConnectionError(true);
                });
        }

        function getStatusColor(status) {
            switch(status) {
                case 'good': return '#00ff88';
                case 'warn': return '#ffaa00';
                case 'bad': return '#ff4444';
                default: return '#fff';
            }
        }

        function updateModeButtons(currentMode) {
            const buttons = ['streaming', 'speed', 'redundant'];
            buttons.forEach(mode => {
                const button = document.getElementById(`mode-${mode}`);
                if (button) {
                    if (mode === currentMode) {
                        button.classList.add('active');
                        button.classList.remove('disabled');
                    } else {
                        button.classList.remove('active');
                        button.classList.remove('disabled');
                    }
                }
            });
        }

        function changeMode(mode) {
            const button = document.getElementById(`mode-${mode}`);

            // Don't change if already active or disabled
            if (button.classList.contains('active') || button.classList.contains('disabled')) {
                return;
            }

            // Debounce: prevent rapid clicks during mode change
            if (modeChangeInProgress) {
                showToast('warning', 'Please Wait', 'Mode change already in progress');
                return;
            }
            modeChangeInProgress = true;

            // Set loading state
            button.classList.add('loading');
            button.textContent = '';

            fetch('/api/change-mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ mode: mode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI immediately to show the change
                    updateModeButtons(mode);
                    document.getElementById("bonding-mode").textContent = mode.toUpperCase();
                    showToast('success', 'Mode Changed', `Switched to ${mode} mode`);

                    // Refresh data after a short delay to get updated status
                    setTimeout(() => {
                        updateStatus();
                    }, 1000);
                } else {
                    console.error('Mode change failed:', data.error);
                    showToast('error', 'Mode Change Failed', data.error);
                }
            })
            .catch(error => {
                console.error('Error changing mode:', error);
                showToast('error', 'Connection Error', 'Could not reach the server');
            })
            .finally(() => {
                // Remove loading state and restore text
                button.classList.remove('loading');
                button.textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
                modeChangeInProgress = false;
            });
        }

        function formatSpeed(bps) {
            if (bps === 0) return '0 bps';
            if (bps >= 1000000) return `${(bps / 1000000).toFixed(1)} Mbps`;
            if (bps >= 1000) return `${(bps / 1000).toFixed(1)} Kbps`;
            return `${bps} bps`;
        }

        // Initial load
        updateServerInfo();
        updateStatus();

        // Status updates every 3 seconds for real-time monitoring
        setInterval(updateStatus, 3000);

        // Server info updates every 30 seconds (rarely changes)
        setInterval(updateServerInfo, 30000);
    </script>
</body>
</html>
